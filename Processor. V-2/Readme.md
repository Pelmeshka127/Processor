# CPU. Vesrion 2

## Содержание
1. [Описание](#описание)
2. [Отличие от предыдущей версии](#отличие-от-предыдущей-версии)
3. [Assembler](#assembler)
4. [CPU](#cpu)
5. [Уcтановка](#уставновка-проекта)

## Описание
Данный проект есть реализация работы процессора, выполняющего команды, написанные на языке ассемблера. Процессор имеет регистры и оперативную память. Исходный код, написанный на языке ассемблера считывается при помощи библиотеки "Parsering" и обрабатывается с помощью токенизации. По окончании работы ассемблера получается файл с машинным кодом, который в последствии обрабатывается уже самим CPU. В процессе работы CPU используется библиотека "Stack".

## Отличие от предыдущей версии
В этой версии процессора исходный текст обрабатывается при помощи токенизации для упрощения работы, когда в предыдущей версии преварительной обработки текстового файла не было. В этой версии не реализован дизассемблер. Также устранены некоторые баги. На данный момент проект дорабатывается.

## Assembler
Самая большая часть проекта. Состоит из токенизации и создании машинного кода.
В процессе токенизации каждое слово исходного текста записывается в специальный массив. Каждое слово массива имеет свой тип и значение, благодаря чему построение машинного кода значительно упрощается.
Пример программы вычисления факториала, написанной на языке ассемблера: 
```Assembler
in
pop rax

call factorial
out
hlt

factorial:
    push rax
    push rax
    push 1
    je exit

    push 1
    push rax
    sub
    pop rax

    call factorial
    mul
    ret

exit:
    ret
```
По окончании преобразования текста в машинный код строится ассемблерный листинг.
``` Text
Line    Adress  Text                            Code

0000    0000    in                              02
0001    0001    pop rax                         68    00
0002    0006                             
0003    0006    call factorial                  12    13
0004    0011    out                             01
0005    0012    hlt                             00
0006    0013                             
0007    0013    factorial:               
0008    0013        push rax                    67    00
0009    0018        push rax                    67    00
0010    0023        push 1                      35    01
0011    0028        je exit                     18    56
0012    0033                             
0013    0033        push 1                      35    01
0014    0038        push rax                    67    00
0015    0043        sub                         06
0016    0044        pop rax                     68    00
0017    0049                             
0018    0049        call factorial              12    13
0019    0054        mul                         07
0020    0055        ret                         11
0021    0056                             
0022    0056    exit:                    
0023    0056        ret 
```

## CPU
Машинный код, полученный при работе ассемблера обрабатывается при помощи CPU, каждая команда содержит определенную инструкцию. В данной реализации имеются регистры и оперативная память. Работу процессора поддерживает Stack. Для работы со стеком используются команды push и pop. 

Список команд и инструкций:

0. `hlt` - завершить работу процессора
1. `out` - взять число из стека и вывести на экран
2. `in` - считывание числа с консоли и положить в стек
3. `push` - добавить число в стек:
```
push 3 - добавить в стек 3
push rax - добавить в стек значение регистра rax
push [rbx + 4] - добавить в стек значение, находящееся по адресу rbx + 4
```

4. `pop` - вынуть число из стека:
```
pop rax - вынуть число из стека и положить в регистр rax
pop [4] - вынуть число из стека и положить в оперативную память по адресу 4
```

5. `add` - сложение
6. `sub` - вычитание
7. `mul` - умножение
8. `div` - деление
9. `sqrt` - извлечение квадратного корня
10. `minus` - умножение числа на -1
11. `ret` - выход из функции
12. `call 'label'` - вызов функции
13. `jmp 'label'` - безусловный переход
14. `jb 'label'` - сделать переход, если меньше
15. `jbe 'label'` - сделать переход, если меньше или равно
16. `ja 'label'` - сделать переход, если больше
17. `jae 'label'` - сделать переход, если больше или равно
18. `je 'label` - сделать переход, если равно
19. `jne 'label'` - сделать переход, если не равно
20. `zero` - вывести "No roots\n"
21. `besk` - вывести "Inf roots\n"

## Уставновка проекта
Процессор написан на macOS

для запуска программы:

```
git clone git@github.com:Pelmeshka127/Processor.git

cd Assembler

make

./assembly ../Tests/<test> prog.bin

cd ..

cd CPU

make

./ciuuupu

```